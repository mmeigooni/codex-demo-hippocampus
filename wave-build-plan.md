# Hippocampus — Wave Build Plan

## Objective

Build "Hippocampus" — a web app that gives Codex teams a shared brain with episodic memory, consolidation, and salience scoring. GitHub OAuth pulls PRs from a public demo eCommerce repo, Codex SDK encodes them into episodes, a 3D brain visualization renders the team's collective memory, and a "sleep cycle" consolidation engine extracts patterns and promotes rules. Addresses the team-governance gap in Codex.

## Scope

| In scope                                    | Out of scope                       |
| ------------------------------------------- | ---------------------------------- |
| GitHub OAuth + repo connection              | Multi-tenant / org management      |
| Episode encoding via Codex SDK (gpt-5-mini) | Real-time webhook-based PR capture |
| ast-grep token optimization                 | Full ast-grep IDE integration      |
| 3D brain visualization (Three.js)           | VR/AR modes                        |
| Sleep cycle consolidation (gpt-5.2)         | Scheduled/automated consolidation  |
| Neural Activity Feed (animated cards)       | Mobile responsive layout           |
| Public shopflow-platform demo repo          | Working eCommerce application      |
| Pack output display                         | Pack distribution / CLI tooling    |
| Meaningful tests (Vitest)                   | E2E browser tests                  |

## Decision Log

| #   | Decision             | Choice                                                 | Rationale                                                                           | Affects                        |
| --- | -------------------- | ------------------------------------------------------ | ----------------------------------------------------------------------------------- | ------------------------------ |
| D1  | Encoding approach    | Hybrid: deterministic metadata + LLM for judgment      | Facts from API (zero tokens). LLM only for pattern ID, salience, narrative.         | WP-017, WP-018                 |
| D2  | Model tier selection | nano (triggers), mini (encoding), 5.2 (consolidation)  | Cognitive load maps to model tier. Never pay frontier for classification.           | WP-017, WP-018, WP-028, WP-029 |
| D3  | Token optimization   | ast-grep structural search rules generated by LLM      | 90% token reduction vs raw diffs. Structural > regex.                               | WP-019                         |
| D4  | UI framework         | shadcn/ui with dark theme via CSS variables            | Copyable components, full control, native dark mode, no Three.js conflicts.         | WP-005, all UI issues          |
| D5  | Demo data source     | Public GitHub repo (shopflow-platform), pulled via API | Same pipeline for demo and real repos. No DB seeding. Reviewers connect to it.      | WP-012-016, WP-020             |
| D6  | 3D library           | react-three-fiber + drei + postprocessing (bloom)      | React-native integration, force graph support, excellent post-processing.           | WP-022-026                     |
| D7  | Streaming approach   | SSE (Server-Sent Events) from API routes               | Simpler than WebSockets for unidirectional progress streaming.                      | WP-020, WP-029                 |
| D8  | Force graph          | r3f-forcegraph or d3-force-3d (decide in spike)        | Need spike to evaluate which integrates better with our node/edge model.            | WP-001, WP-022                 |
| D9  | Animation library    | react-spring/three (3D), Framer Motion (UI)            | Physics-based 3D transitions, Framer for micro-interactions and feed cards.         | WP-022-026, WP-027             |
| D10 | Onboarding UX        | Neural Activity Feed (styled cards, not logs)          | Every step has visual feedback. No dead air. Part of the product, not afterthought. | WP-027                         |

---

## Wave 01 — Spike: Verify Integrations

> Read-only research. No code ships. Verify that our key integration assumptions hold.

### WP-001: Verify Codex SDK structured output + streaming

- **Priority:** P0
- **Dependencies:** none
- **Files:** none (read-only research)
- **Objective:** Confirm Codex SDK supports `thread.run()` with `outputSchema` for structured JSON, and `runStreamed()` for event streaming. Determine auth method (ChatGPT vs API key). Determine which models are available via SDK.
- **Implementation notes:**
  - Install `@openai/codex-sdk`, authenticate, run a test prompt with JSON schema output
  - Test `runStreamed()` and capture event types
  - Document: auth method, available models, event types, structured output format
  - Check if gpt-5-mini and gpt-5-nano are accessible via SDK
- **Acceptance criteria:**
  - [ ] Documented: SDK auth method + available models
  - [ ] Documented: structured output works with schema
  - [ ] Documented: streaming event types and format
- **Evidence:** Markdown document with findings and code snippets

### WP-002: Verify ast-grep Node.js integration

- **Priority:** P1
- **Dependencies:** none
- **Files:** none (read-only research)
- **Objective:** Confirm ast-grep can be invoked from Node.js to search code strings (not just files). Determine if we can pass a diff string and get structural matches back.
- **Implementation notes:**
  - Install `@ast-grep/napi` (the Node.js binding)
  - Test: pass a code string, apply a pattern rule, get matches
  - Document: API surface, how to generate rules, how to process results
  - If direct string search isn't supported, document alternative (temp file approach)
- **Acceptance criteria:**
  - [ ] Documented: ast-grep Node.js API for searching code strings
  - [ ] Documented: how to define search patterns programmatically
  - [ ] Documented: fallback approach if string search isn't directly supported
- **Evidence:** Markdown document with findings and code snippets

### WP-003: Verify react-three-fiber force graph + bloom

- **Priority:** P1
- **Dependencies:** none
- **Files:** none (read-only research)
- **Objective:** Confirm r3f-forcegraph (or alternative) works with react-three-fiber v9+, postprocessing bloom, and react-spring animations. Determine best approach for our node/edge model.
- **Implementation notes:**
  - Test: r3f-forcegraph with custom node rendering
  - Test: @react-three/postprocessing Bloom on selected nodes
  - Test: react-spring/three for animating node positions/opacity
  - Test: drei Sparkles for particle effects
  - Document: which libraries to use, any version conflicts, performance notes
- **Acceptance criteria:**
  - [ ] Documented: force graph library choice with rationale
  - [ ] Documented: bloom setup for selective glow
  - [ ] Documented: animation approach for state transitions
- **Evidence:** Markdown document with findings, screenshots if helpful

**Parallelism:** WP-001, WP-002, WP-003 all parallel (zero file overlap, all read-only).

**Wave exit:** All three spike documents complete. Key integration assumptions confirmed or alternatives documented. No blocking unknowns for Wave 02.

---

## Wave 02 — Foundation: Project Scaffolding

> Next.js app exists with dark theme, Supabase schema deployed, Codex config in place.

### WP-004: Initialize Next.js + Tailwind + shadcn/ui dark theme

- **Priority:** P0
- **Dependencies:** none
- **Files:** `package.json`, `next.config.ts`, `tsconfig.json`, `tailwind.config.ts`, `postcss.config.ts`, `app/layout.tsx`, `app/globals.css`, `app/page.tsx`, `components/ui/*`
- **Objective:** Next.js 14+ App Router project with Tailwind v4, shadcn/ui initialized with dark theme as default. Landing page renders.
- **Implementation notes:**
  - `npx create-next-app@latest` with TypeScript, Tailwind, App Router
  - `npx shadcn@latest init` — select dark theme, CSS variables
  - Add shadcn components: Button, Card, Sheet, Dialog, Badge, Accordion, Separator, Tooltip
  - Set dark mode as default in globals.css (dark class on html)
  - Landing page: minimal, just "Hippocampus" title + login button placeholder
  - Per D4: shadcn/ui with CSS variables for theming
- **Acceptance criteria:**
  - [ ] `npm run dev` serves app at localhost:3000
  - [ ] Dark theme renders by default
  - [ ] `npx next build` succeeds
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** `next build` output, screenshot of landing page

### WP-005: Supabase schema + client setup

- **Priority:** P0
- **Dependencies:** none
- **Files:** `supabase/migrations/001_initial_schema.sql`, `lib/supabase/client.ts`, `lib/supabase/server.ts`, `.env.local.example`
- **Objective:** Supabase migration defines all tables. Client and server helpers created. Env vars documented.
- **Implementation notes:**
  - Schema from plan: profiles, repos, episodes, rules, index_entries, consolidation_runs
  - Use `@supabase/ssr` for server-side client (App Router compatible)
  - `@supabase/supabase-js` for browser client
  - `.env.local.example` with NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY
  - Do NOT set up auth yet (Wave 03)
- **Acceptance criteria:**
  - [ ] Migration file contains all 6 tables with correct columns and types
  - [ ] `lib/supabase/client.ts` exports `createBrowserClient()`
  - [ ] `lib/supabase/server.ts` exports `createServerClient()`
  - [ ] `.env.local.example` documents required env vars
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Migration SQL, TypeScript compiles

### WP-006: AGENTS.md + Codex config + prompt files

- **Priority:** P1
- **Dependencies:** none
- **Files:** `AGENTS.md`, `.codex/config.toml`, `.codex/prompts/encode-episode.md`, `.codex/prompts/consolidate.md`, `.codex/prompts/generate-triggers.md`
- **Objective:** Repo is a showcase of Codex best practices. AGENTS.md describes architecture. Config sets model defaults. Prompt files are reusable.
- **Implementation notes:**
  - AGENTS.md: project overview, architecture, file map, conventions, key decisions (reference decision log)
  - config.toml: model defaults, sandbox mode, approval policy
  - Prompt files: each is a self-contained prompt for its task (encoding, consolidation, trigger gen)
  - Per D2: reference model tier selection in config
- **Acceptance criteria:**
  - [ ] AGENTS.md describes project architecture, conventions, and file layout
  - [ ] .codex/config.toml has valid TOML with model and sandbox settings
  - [ ] All three prompt files exist with clear instructions and output schemas
- **Evidence:** Files exist and are well-structured

**Parallelism:** WP-004, WP-005, WP-006 all parallel (zero file overlap).

**Wave exit:** `npx next build` succeeds. Dark-themed landing page renders. Supabase migration ready to deploy. Codex config files in place.

---

## Wave 03 — Auth + Application Shell

> User can login with GitHub, see an authenticated dashboard with header/sidebar.

### WP-007: GitHub OAuth via Supabase + auth callback

- **Priority:** P0
- **Dependencies:** WP-004, WP-005
- **Files:** `app/api/auth/callback/route.ts`, `middleware.ts`, `lib/supabase/middleware.ts`
- **Objective:** GitHub OAuth flow works end-to-end. Callback creates/updates profile. Middleware protects `/dashboard/*` routes.
- **Implementation notes:**
  - Follow Supabase Auth with Next.js App Router guide
  - Callback route exchanges code for session
  - Middleware checks session, redirects unauthenticated users to login
  - Request `repo` scope in GitHub OAuth for PR access
  - Profile row created/updated on login (upsert on github_username, avatar_url)
- **Acceptance criteria:**
  - [ ] Clicking "Login with GitHub" redirects to GitHub OAuth
  - [ ] After auth, user is redirected to /dashboard
  - [ ] Profile row exists in Supabase with github_username and avatar_url
  - [ ] Unauthenticated access to /dashboard redirects to /
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Login flow works, profile in Supabase dashboard

### WP-008: Login page with GitHub button

- **Priority:** P0
- **Dependencies:** WP-004
- **Files:** `app/page.tsx`
- **Objective:** Landing page has a polished "Login with GitHub" button that initiates OAuth.
- **Implementation notes:**
  - Use shadcn Button component
  - Call `supabase.auth.signInWithOAuth({ provider: 'github', options: { scopes: 'repo' } })`
  - Dark theme, centered layout, "Hippocampus" branding
  - Minimal but polished — this is the first thing anyone sees
- **Acceptance criteria:**
  - [ ] Login button visible on landing page
  - [ ] Clicking button initiates GitHub OAuth flow
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Screenshot of login page

### WP-009: Dashboard layout (header + sidebar + main area)

- **Priority:** P0
- **Dependencies:** WP-004
- **Files:** `app/dashboard/layout.tsx`, `app/dashboard/page.tsx`, `components/layout/Header.tsx`, `components/layout/Sidebar.tsx`
- **Objective:** Authenticated dashboard has a header (user avatar, app name) and sidebar (navigation). Main content area is a placeholder ready for brain viz + feed.
- **Implementation notes:**
  - Header: app name "Hippocampus", user avatar from GitHub (via Supabase session), logout button
  - Sidebar: nav links — Dashboard, Episodes, Sleep Cycle
  - Main area: flex container, placeholder text "Connect a repo to build your brain"
  - Use shadcn components where appropriate
  - Dark theme, bioluminescent accent colors (cyan, gold)
- **Acceptance criteria:**
  - [ ] Header shows user avatar and app name
  - [ ] Sidebar has navigation links
  - [ ] Main content area renders placeholder
  - [ ] Logout button works (redirects to /)
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Screenshot of dashboard shell

**Parallelism:** WP-008 and WP-009 parallel (different files). WP-007 sequential before both (middleware needed).

**Wave exit:** Full login → dashboard flow works. `npx next build` succeeds. Authenticated and unauthenticated states both work correctly.

---

## Wave 04 — GitHub API + Repo Connection

> App can fetch PRs with reviews from any public GitHub repo. Repo selector UI works.

### WP-010: GitHub API client (Octokit wrapper)

- **Priority:** P0
- **Dependencies:** WP-005
- **Files:** `lib/github/client.ts`, `lib/github/types.ts`
- **Objective:** Octokit wrapper that fetches merged PRs with review comments from a given repo. Types defined for PR data.
- **Implementation notes:**
  - Install `octokit`
  - Auth with user's GitHub token from Supabase session (or unauthenticated for public repos)
  - Functions: `fetchMergedPRs(owner, repo, limit)`, `fetchPRReviews(owner, repo, prNumber)`, `fetchPRDiff(owner, repo, prNumber)`
  - Types: `GitHubPR`, `GitHubReview`, `GitHubReviewComment`
  - Handle pagination, rate limiting
  - Per D5: works with public repos without auth token
- **Acceptance criteria:**
  - [ ] `fetchMergedPRs` returns PR metadata (title, author, number, merged_at)
  - [ ] `fetchPRReviews` returns review comments with body, author, file path
  - [ ] `fetchPRDiff` returns diff string
  - [ ] Types exported and used consistently
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** TypeScript compiles, types defined

### WP-011: Repo connection API route

- **Priority:** P0
- **Dependencies:** WP-005, WP-010
- **Files:** `app/api/github/repos/route.ts`, `app/api/github/import/route.ts`
- **Objective:** API routes to list user's repos and trigger PR import for a selected repo. Import route returns SSE stream of progress events.
- **Implementation notes:**
  - GET `/api/github/repos` — list user's repos (via Octokit with session token)
  - POST `/api/github/import` — accepts `{ owner, repo }`, creates repo record in Supabase, fetches PRs, streams progress via SSE
  - SSE events: `{ type: 'pr_found', data: { count } }`, `{ type: 'encoding_start', data: { pr_number, title } }`, `{ type: 'episode_created', data: { episode } }`, `{ type: 'complete', data: { total } }`
  - For now, the actual Codex encoding is stubbed — just creates placeholder episodes from PR metadata
  - Per D7: SSE streaming from Next.js API route
- **Acceptance criteria:**
  - [ ] GET /api/github/repos returns list of repos for authenticated user
  - [ ] POST /api/github/import creates repo record and fetches PRs
  - [ ] SSE stream emits progress events
  - [ ] Placeholder episodes created in Supabase
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** API responses, SSE events in browser devtools

### WP-012: Repo selector UI component

- **Priority:** P1
- **Dependencies:** WP-009
- **Files:** `components/onboarding/RepoSelector.tsx`, `components/onboarding/OnboardingFlow.tsx`
- **Objective:** UI for selecting a repo to connect. Shows shopflow-platform as recommended default. "Connect your own repo" shows user's repos.
- **Implementation notes:**
  - RepoSelector: two paths — recommended demo repo card + "your repos" dropdown
  - shopflow-platform card is hardcoded (public repo, always available)
  - "Your repos" fetches from GET /api/github/repos
  - OnboardingFlow: wrapper that shows RepoSelector, then transitions to import progress
  - Use shadcn Card, Button, Select components
- **Acceptance criteria:**
  - [ ] shopflow-platform appears as recommended option
  - [ ] "Connect your own repo" shows user's repos from API
  - [ ] Selecting a repo triggers import
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Screenshot of repo selector

**Parallelism:** WP-010 and WP-012 parallel (different files). WP-011 sequential after WP-010 (depends on GitHub client).

**Wave exit:** Can select shopflow-platform (or any public repo), fetch PRs, see SSE progress events. Placeholder episodes created in Supabase. `npx next build` succeeds.

---

## Wave 05 — Demo Repo: shopflow-platform

> Public GitHub repo exists with scaffolded eCommerce codebase and 15-20+ PRs with realistic review conversations.

**Note:** This wave operates on a **separate repository** (shopflow-platform). It can execute **in parallel** with Wave 04 and Wave 06 in the app repo. Zero file overlap.

### WP-013: Scaffolded eCommerce codebase

- **Priority:** P0
- **Dependencies:** none
- **Files:** entire shopflow-platform repo (separate repo)
- **Objective:** A minimal but realistic eCommerce codebase exists. Services, shared utilities, config. Looks real when browsing GitHub.
- **Implementation notes:**
  - Create public repo: shopflow-platform
  - Structure: services/payments, services/catalog, services/checkout, services/orders
  - Shared: shared/auth, shared/logging, shared/db
  - Each service has: routes, handlers, models (TypeScript, minimal implementation)
  - Config files, README, package.json
  - NOT a working app — just enough structure for PR diffs to make contextual sense
- **Acceptance criteria:**
  - [ ] Public repo exists on GitHub
  - [ ] 4 service directories with basic file structure
  - [ ] Shared utilities directory
  - [ ] README describes the "platform"
- **Evidence:** GitHub repo URL

### WP-014: High-salience PRs with reviews (episodes 1-7)

- **Priority:** P0
- **Dependencies:** WP-013
- **Files:** shopflow-platform repo (PRs)
- **Objective:** 7 PRs with detailed review conversations exist. High-salience incidents (scores 8-10). Each PR has back-and-forth review comments.
- **Implementation notes:**
  - Create branches, make realistic code changes, open PRs, add review comments, merge
  - Each PR needs: descriptive title, code diff, 2-4 review comments with explanations
  - PRs: retry cascade, PII in logs, auth token leakage, race condition, SQL injection, unvalidated redirect, memory leak
  - Review comments should explain WHY the pattern is dangerous, not just flag it
  - Use realistic reviewer names/personas
- **Acceptance criteria:**
  - [ ] 7 merged PRs with review comments visible on GitHub
  - [ ] Each PR has code diff that makes sense against the codebase
  - [ ] Review comments explain the pattern and the fix
- **Evidence:** GitHub PR URLs

### WP-015: Medium + low salience PRs (episodes 8-18)

- **Priority:** P1
- **Dependencies:** WP-013
- **Files:** shopflow-platform repo (PRs)
- **Objective:** 11 additional PRs covering medium and low salience patterns. Includes the contradiction pair.
- **Implementation notes:**
  - Medium (5-7): N+1 query, missing pagination, hardcoded secrets, no rate limiting, missing validation, sync email, unbounded query
  - Low (2-4): inconsistent errors, missing types, console.log in prod, unused imports
  - Contradiction pair: "always retry failed payments" vs "never retry on 4xx" — these must reference each other's services
  - Less detailed review conversations than high-salience (reflects reality)
- **Acceptance criteria:**
  - [ ] 11 merged PRs with review comments
  - [ ] Contradiction pair exists and is identifiable
  - [ ] Salience levels span 2-7
- **Evidence:** GitHub PR URLs

**Parallelism:** WP-014 and WP-015 parallel (different PRs, both depend on WP-013). This wave runs in parallel with app Waves 04-06.

**Wave exit:** shopflow-platform has 18+ merged PRs with realistic review conversations. Contradiction pair exists. Repo is public and browsable.

---

## Wave 06 — Episode Encoding Pipeline

> Codex SDK processes PRs into structured episodes with ast-grep token optimization.

### WP-016: Codex SDK client setup

- **Priority:** P0
- **Dependencies:** WP-001 (spike findings)
- **Files:** `lib/codex/client.ts`
- **Objective:** Codex SDK client configured with correct auth method and model defaults. Reusable across encoding and consolidation.
- **Implementation notes:**
  - Based on WP-001 spike findings for auth method
  - Configure with model defaults per D2
  - Export: `createCodexThread()`, `runWithSchema<T>(thread, prompt, schema)`
  - Handle errors, timeouts
- **Acceptance criteria:**
  - [ ] Client connects to Codex SDK successfully
  - [ ] `runWithSchema` returns typed JSON matching provided schema
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Successful SDK call output

### WP-017: Episode encoder (hybrid deterministic + LLM)

- **Priority:** P0
- **Dependencies:** WP-016, WP-010
- **Files:** `lib/codex/encoder.ts`, `lib/codex/types.ts`
- **Objective:** Given raw PR data from GitHub API, produces a structured episode. Deterministic fields extracted from API. LLM (gpt-5-mini) handles narrative, pattern identification, salience.
- **Implementation notes:**
  - Per D1: deterministic extraction for who, when, where, source
  - Per D2: use gpt-5-mini for encoding
  - Input: `GitHubPR` + `GitHubReview[]` + code snippets (from ast-grep, or full review comments if ast-grep not ready)
  - Output: `Episode` type matching DB schema
  - Use `.codex/prompts/encode-episode.md` as the prompt template
  - Output schema enforced via Codex SDK `outputSchema`
- **Acceptance criteria:**
  - [ ] `encodeEpisode(prData)` returns structured Episode matching schema
  - [ ] Deterministic fields (who, when, source) extracted without LLM
  - [ ] LLM fields (what_happened, the_pattern, the_fix, salience_score, triggers) populated
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Encoded episode JSON from a real ShopFlow PR

### WP-018: ast-grep token optimization layer

- **Priority:** P1
- **Dependencies:** WP-002 (spike findings), WP-016
- **Files:** `lib/codex/search.ts`
- **Objective:** Instead of passing full PR diffs to the encoder, generate ast-grep rules to extract only relevant code snippets. Per D3.
- **Implementation notes:**
  - Based on WP-002 spike findings
  - Function: `generateSearchRules(reviewComments)` — uses gpt-5-nano to generate ast-grep patterns from review context
  - Function: `executeSearch(diff, rules)` — runs ast-grep rules against the diff, returns matching snippets
  - If WP-002 spike found ast-grep can't search strings directly, implement temp-file approach
  - Fallback: if ast-grep integration is problematic, return full review-adjacent code blocks
- **Acceptance criteria:**
  - [ ] `generateSearchRules` produces valid ast-grep patterns
  - [ ] `executeSearch` returns code snippets matching the patterns
  - [ ] Token reduction measurable (log input size with/without optimization)
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Log showing token reduction ratio

### WP-019: Wire encoding into import pipeline

- **Priority:** P0
- **Dependencies:** WP-011, WP-017
- **Files:** `app/api/github/import/route.ts`
- **Objective:** The import API route (from WP-011) now uses real Codex encoding instead of placeholder stubs. SSE events include encoding progress.
- **Implementation notes:**
  - Replace stub in `/api/github/import` with real encoder calls
  - For each PR: fetch reviews → (optionally) ast-grep search → encode episode → save to Supabase
  - SSE events updated: include pattern detected, salience score, trigger keywords in events
  - Handle encoding errors gracefully (skip PR, report in stream)
- **Acceptance criteria:**
  - [ ] Import of shopflow-platform PRs produces real structured episodes
  - [ ] Episodes stored in Supabase with all fields populated
  - [ ] SSE stream includes encoding details (pattern, salience, triggers)
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Episodes in Supabase dashboard, SSE event log

**Parallelism:** WP-016 first. Then WP-017 and WP-018 parallel (different files). WP-019 sequential after WP-017.

**Wave exit:** Importing shopflow-platform produces real structured episodes in Supabase. Encoding uses Codex SDK with structured output. SSE streams progress. `npx next build` succeeds.

---

## Wave 07 — Brain Visualization

> 3D brain renders episodes as glowing nodes with connections and interactions.

### WP-020: Three.js scene setup + postprocessing

- **Priority:** P0
- **Dependencies:** WP-003 (spike findings), WP-004
- **Files:** `components/brain/BrainScene.tsx`, `components/brain/ParticleField.tsx`
- **Objective:** Three.js canvas renders with react-three-fiber. Bloom postprocessing active. Ambient particles (drei Sparkles). OrbitControls for zoom/rotate. Dark background.
- **Implementation notes:**
  - Per D6: react-three-fiber + drei + postprocessing
  - Canvas with dark background (#0a0a0f or similar)
  - EffectComposer with Bloom (intensity, threshold, radius tuned for glow)
  - Sparkles for ambient particle field
  - OrbitControls: zoom, rotate, pan
  - No data yet — just the empty scene with atmosphere
- **Acceptance criteria:**
  - [ ] Canvas renders on dashboard page
  - [ ] Bloom effect visible
  - [ ] Particles floating in scene
  - [ ] Orbit controls work (mouse drag to rotate)
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Screenshot of empty brain scene with bloom and particles

### WP-021: Episode nodes + rule nodes

- **Priority:** P0
- **Dependencies:** WP-020
- **Files:** `components/brain/EpisodeNode.tsx`, `components/brain/RuleNode.tsx`
- **Objective:** Episodes render as glowing spheres (cyan). Rules render as larger gold spheres. Size scales with salience. Brightness scales with recency.
- **Implementation notes:**
  - EpisodeNode: sphere geometry, MeshStandardMaterial with emissive cyan
  - Size = basSize + (salience / 10) \* scaleMultiplier
  - Brightness = opacity based on days since created (recent = 1.0, old = 0.4)
  - RuleNode: same but gold emissive, 1.5x base size
  - Bloom makes emissive materials glow automatically
  - Accept position prop (will be set by force layout)
- **Acceptance criteria:**
  - [ ] Episode nodes render as cyan glowing spheres
  - [ ] Rule nodes render as gold glowing spheres
  - [ ] Size varies with salience prop
  - [ ] Brightness varies with recency prop
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Screenshot showing nodes of varying size/brightness

### WP-022: Neural edges + force layout

- **Priority:** P0
- **Dependencies:** WP-020, WP-021
- **Files:** `components/brain/NeuralEdge.tsx`, `components/brain/BrainGraph.tsx`
- **Objective:** Edges connect episodes sharing triggers. Force-directed layout positions nodes. Graph component composes nodes + edges + layout.
- **Implementation notes:**
  - Per D8: use force layout library from spike findings
  - BrainGraph: takes episodes[] and rules[] as props, computes edges from shared triggers, runs force layout, positions nodes
  - NeuralEdge: line geometry between node positions, opacity based on connection strength (shared trigger count)
  - Edge color: subtle cyan/white, thin
  - Layout should settle smoothly (spring physics via react-spring or force sim)
- **Acceptance criteria:**
  - [ ] Nodes connected by edges when they share triggers
  - [ ] Force layout distributes nodes in 3D space
  - [ ] Edges visible with varying opacity
  - [ ] Layout settles without jitter
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Screenshot of connected node graph

### WP-023: Node interactions (click, hover)

- **Priority:** P1
- **Dependencies:** WP-022
- **Files:** `components/brain/NodeInteraction.tsx`
- **Objective:** Hovering a node shows title + salience. Clicking opens episode detail panel.
- **Implementation notes:**
  - Hover: drei Html overlay positioned at node, shows title + salience badge
  - Click: dispatches event / calls callback with episode ID
  - Episode detail panel will be built in a later wave — for now just console.log on click
  - Raycasting via react-three-fiber's built-in onPointerOver / onClick
- **Acceptance criteria:**
  - [ ] Hovering a node shows tooltip with title and salience
  - [ ] Clicking a node logs episode ID to console
  - [ ] Hover/click don't interfere with OrbitControls
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Screenshot of hover tooltip

**Parallelism:** WP-020 first. WP-021 after WP-020. WP-022 after WP-021. WP-023 after WP-022. (Sequential chain — each builds on prior.)

**Wave exit:** 3D brain renders episodes from Supabase as glowing nodes with connections. Force layout, bloom, particles, hover/click all working. `npx next build` succeeds.

---

## Wave 08 — Neural Activity Feed + Onboarding

> Import flow shows beautiful animated progress cards. Brain populates in real-time.

### WP-024: Activity card component

- **Priority:** P0
- **Dependencies:** WP-004
- **Files:** `components/feed/ActivityCard.tsx`, `components/feed/CodeSnippet.tsx`, `components/feed/SalienceBadge.tsx`, `components/feed/TriggerPill.tsx`
- **Objective:** Individual feed card component with Framer Motion animations. Supports: text events, code snippets, salience bars, trigger pills.
- **Implementation notes:**
  - Per D10: styled cards, not logs
  - Framer Motion: `motion.div` with spring slide-in from left, opacity fade-in
  - Card types: status (fetching PRs...), encoding (pattern detected + code), connection (edges formed), complete
  - CodeSnippet: syntax-highlighted code block (use a lightweight highlighter like prism-react-renderer or shiki)
  - SalienceBadge: colored bar ████████░░ 8/10
  - TriggerPill: styled keyword badges with glow
  - Glowing accent colors: cyan, gold, red matching brain palette
  - Timing badge in top-right corner
- **Acceptance criteria:**
  - [ ] Activity card renders with slide-in animation
  - [ ] Code snippets syntax-highlighted
  - [ ] Salience badge renders as visual bar
  - [ ] Trigger pills render as styled badges
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Screenshot of activity cards in different states

### WP-025: Neural Activity Feed (SSE consumer)

- **Priority:** P0
- **Dependencies:** WP-024, WP-011
- **Files:** `components/feed/NeuralActivityFeed.tsx`
- **Objective:** Feed component consumes SSE stream from import API. Each event renders as an ActivityCard. Auto-scrolls. Staggered animation.
- **Implementation notes:**
  - Connect to SSE endpoint via EventSource
  - Map SSE event types to ActivityCard variants
  - Stagger: new cards appear with 100-200ms delay between them
  - Auto-scroll to bottom as new cards appear
  - Show progress indicator at top (X/Y episodes encoded)
- **Acceptance criteria:**
  - [ ] Feed consumes SSE events from /api/github/import
  - [ ] Each event renders as an animated card
  - [ ] Cards stagger in with spring animation
  - [ ] Feed auto-scrolls
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Video/gif of feed populating during import

### WP-026: Wire feed + brain into dashboard

- **Priority:** P0
- **Dependencies:** WP-022 (brain), WP-025 (feed), WP-012 (repo selector)
- **Files:** `app/dashboard/page.tsx`
- **Objective:** Dashboard page composes: repo selector (if no repo connected) → brain viz + activity feed side by side. Brain populates as feed receives events.
- **Implementation notes:**
  - State: if no repo connected, show OnboardingFlow (repo selector → import)
  - State: if repo connected, show brain (left/center) + feed (right sidebar)
  - Brain receives episodes from Supabase (fetch on load) + real-time updates during import
  - Feed shows import progress during encoding, then switches to episode log
  - Layout: brain takes 60-70% width, feed takes 30-40%
  - Brain nodes appear as episodes are created (listen to feed events, refetch/update episodes state)
- **Acceptance criteria:**
  - [ ] No repo: shows repo selector
  - [ ] During import: brain + feed visible, brain populates as episodes encode
  - [ ] After import: brain shows all episodes, feed shows history
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Screenshot of dashboard with brain + feed during import

**Parallelism:** WP-024 parallel with earlier waves (no shared files). WP-025 after WP-024. WP-026 after WP-025 + Wave 07.

**Wave exit:** Full onboarding flow works: select repo → import → brain populates with animated feed. No dead air during import. `npx next build` succeeds.

---

## Wave 09 — Sleep Cycle

> Consolidation engine processes episodes via Codex SDK. Brain enters dream state. Rules emerge.

### WP-027: Consolidation engine (Codex SDK)

- **Priority:** P0
- **Dependencies:** WP-016, WP-017
- **Files:** `lib/codex/consolidator.ts`
- **Objective:** Given a set of episodes, uses Codex SDK (gpt-5.2) to find patterns, promote rules, detect contradictions, and score salience. Returns structured consolidation result.
- **Implementation notes:**
  - Per D2: use gpt-5.2 for consolidation (complex reasoning)
  - Use `.codex/prompts/consolidate.md` as prompt template
  - Input: Episode[] (full episode data)
  - Output: `ConsolidationResult { patterns: Pattern[], rules_to_promote: Rule[], contradictions: Contradiction[], salience_updates: SalienceUpdate[], prune_candidates: string[] }`
  - Multi-step: replay → connect → promote → score → prune → conflict
  - Each step should be a separate Codex call for streaming granularity
  - Per D2: this is the gpt-5.2 task — complex cross-episode reasoning
- **Acceptance criteria:**
  - [ ] `runConsolidation(episodes)` returns structured result
  - [ ] Patterns found across related episodes
  - [ ] At least one rule promoted from pattern group
  - [ ] Contradiction pair detected (if present in input)
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Consolidation result JSON from ShopFlow episodes

### WP-028: Consolidation API route (SSE)

- **Priority:** P0
- **Dependencies:** WP-027
- **Files:** `app/api/consolidate/route.ts`
- **Objective:** POST endpoint triggers consolidation. Streams progress via SSE. Saves results to Supabase (new rules, updated salience, consolidation_run record).
- **Implementation notes:**
  - Fetch all episodes for the repo from Supabase
  - Run consolidation engine (WP-027)
  - Stream events: `{ type: 'replay_start' }`, `{ type: 'pattern_found', data: {...} }`, `{ type: 'rule_promoted', data: {...} }`, `{ type: 'contradiction_detected', data: {...} }`, `{ type: 'complete', data: { summary } }`
  - Save: new rules to rules table, update episode salience scores, create consolidation_run record
  - Update index_entries with new rule entries
- **Acceptance criteria:**
  - [ ] POST /api/consolidate triggers consolidation
  - [ ] SSE stream emits progress events for each step
  - [ ] New rules saved to Supabase
  - [ ] Episode salience scores updated
  - [ ] consolidation_run record created
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** SSE events, new rules in Supabase

### WP-029: Sleep cycle UI + brain dream state

- **Priority:** P0
- **Dependencies:** WP-028, WP-022 (brain)
- **Files:** `components/brain/SleepTransition.tsx`, `components/sleep-cycle/ConsolidationConsole.tsx`, `components/sleep-cycle/ConsolidationReport.tsx`, `app/sleep-cycle/page.tsx`
- **Objective:** "Run Sleep Cycle" button triggers consolidation. Brain enters dream state (dark, sequential illumination). Neural Activity Feed shows consolidation insights. Results displayed after completion.
- **Implementation notes:**
  - Sleep cycle page: "Run Sleep Cycle" button + brain viz + consolidation feed
  - Dream state transition: brain background darkens, node animations slow, sequential replay illumination
  - Per D9: react-spring/three for 3D transitions, Framer Motion for UI
  - Consolidation feed: reuses NeuralActivityFeed/ActivityCard with consolidation-specific card types
  - ConsolidationReport: summary card showing patterns found, rules promoted, contradictions
  - New rule nodes appear in brain (gold) when promoted
  - Pruned nodes fade out
  - Post-sleep: brain returns to awake state but visibly changed
- **Acceptance criteria:**
  - [ ] "Run Sleep Cycle" triggers consolidation
  - [ ] Brain enters dark "dream" state
  - [ ] Nodes illuminate sequentially during replay
  - [ ] New gold rule nodes appear when rules promoted
  - [ ] Feed shows consolidation progress as styled cards
  - [ ] Report summarizes results
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Screenshots/video of sleep cycle animation

**Parallelism:** WP-027 first. WP-028 after WP-027. WP-029 after WP-028.

**Wave exit:** Full sleep cycle works: click button → brain dreams → rules promoted → brain wakes up changed. SSE streaming throughout. New rules visible in brain. `npx next build` succeeds. `npx vitest run` passes.

---

## Wave 10 — Episodes, Pack Output, and Tests

> Episode detail view, pack output, and meaningful test coverage.

### WP-030: Episode detail panel

- **Priority:** P1
- **Dependencies:** WP-023 (node click), WP-024 (card components)
- **Files:** `components/episodes/EpisodeDetail.tsx`, `app/episodes/page.tsx`, `components/episodes/EpisodeCard.tsx`
- **Objective:** Clicking a brain node opens episode detail. Episodes page shows full list. Each episode displays the full narrative.
- **Implementation notes:**
  - EpisodeDetail: shadcn Sheet (slide-in panel) with full episode data
  - Fields: title, salience badge, who, what_happened, the_pattern, the_fix, why_it_matters, trigger pills, source PR link
  - Wire into brain node click handler (WP-023)
  - Episodes page: list view with EpisodeCards, filterable by salience/trigger
  - EpisodeCard: compact card with title, salience, triggers
- **Acceptance criteria:**
  - [ ] Clicking brain node opens episode detail panel
  - [ ] Episode detail shows all fields
  - [ ] Episodes page lists all episodes
  - [ ] Source PR link works (opens GitHub)
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Screenshot of episode detail panel

### WP-031: Generated pack output view

- **Priority:** P1
- **Dependencies:** WP-028 (consolidation)
- **Files:** `components/sleep-cycle/PackOutput.tsx`
- **Objective:** After consolidation, display the generated "pack" — the consolidated rules formatted as something Codex could use (TOML config or markdown instructions).
- **Implementation notes:**
  - Render consolidated rules as a formatted config/document
  - Show: rule title, description, source episodes, triggers
  - Format as `.codex/pack.toml` style or markdown base-instructions
  - Include provenance: "This rule originated from episodes: ep_001, ep_002"
  - Copy-to-clipboard button
- **Acceptance criteria:**
  - [ ] Pack output renders after consolidation
  - [ ] Shows all promoted rules with provenance
  - [ ] Formatted as Codex-compatible config
  - [ ] Copy button works
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Screenshot of pack output

### WP-032: Meaningful tests

- **Priority:** P0
- **Dependencies:** WP-017, WP-027
- **Files:** `tests/salience.test.ts`, `tests/triggers.test.ts`, `tests/encoder.test.ts`, `tests/consolidation.test.ts`, `vitest.config.ts`
- **Objective:** Test suite covering core logic: salience scoring, trigger matching, episode encoding structure, and consolidation output structure.
- **Implementation notes:**
  - Install vitest + dependencies
  - Salience tests: score computation, decay over time, boost on retrieval
  - Trigger tests: trigger matching against code patterns, overlap detection
  - Encoder tests: verify deterministic fields are extracted correctly, verify output schema
  - Consolidation tests: verify pattern detection across episode sets, verify contradiction detection
  - Mock Codex SDK calls in tests (don't hit real API)
- **Acceptance criteria:**
  - [ ] `npx vitest run` passes all tests
  - [ ] 4+ test files covering distinct concerns
  - [ ] Tests are meaningful (not trivial/tautological)
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** `npx vitest run` output

**Parallelism:** WP-030, WP-031, WP-032 all parallel (different files).

**Wave exit:** Episode detail works from brain click. Pack output displays after consolidation. All tests pass. `npx next build && npx vitest run` succeeds.

---

## Wave 11 — Polish + Demo Prep

> Visual polish, error handling, end-to-end verification, demo practice.

### WP-033: Visual polish + error handling

- **Priority:** P1
- **Dependencies:** all prior waves
- **Files:** various (loading states, error boundaries, transitions)
- **Objective:** Loading states for all async operations. Error boundaries. Smooth page transitions. No broken UX states.
- **Implementation notes:**
  - Loading skeletons for brain (while episodes fetch)
  - Error states: failed import, failed consolidation, network errors
  - Page transitions between dashboard/episodes/sleep-cycle (Framer Motion)
  - Empty states: "No episodes yet — connect a repo"
  - Review all user-facing flows for dead air or broken states
- **Acceptance criteria:**
  - [ ] All async operations show loading state
  - [ ] Errors display user-friendly messages
  - [ ] No blank/broken screens in any flow
  - [ ] `npx next build` succeeds
- **Evidence:** Screenshots of loading/error states

### WP-034: End-to-end flow verification

- **Priority:** P0
- **Dependencies:** WP-033
- **Files:** none (testing only)
- **Objective:** Full flow works: login → select shopflow-platform → import → brain populates → explore episodes → run sleep cycle → see rules + pack.
- **Implementation notes:**
  - Fresh login with GitHub
  - Select shopflow-platform
  - Watch brain populate (verify all 18+ episodes appear)
  - Click nodes, verify detail panel
  - Run sleep cycle, verify dream state animation
  - Verify rules promoted, contradictions flagged
  - Verify pack output
  - Run multiple times to practice demo narrative
- **Acceptance criteria:**
  - [ ] Full flow works end-to-end without errors
  - [ ] Brain has 18+ nodes after import
  - [ ] Sleep cycle produces 3+ rules
  - [ ] Contradiction pair detected
  - [ ] All tests pass: `npx vitest run`
  - [ ] Build succeeds: `npx next build`
- **Evidence:** Full flow walkthrough documented

**Parallelism:** WP-033 then WP-034 (sequential).

**Wave exit:** App is demo-ready. All flows work. All tests pass. Build succeeds. Ready for video recording.

---

## File Ownership Matrix

| File                                     | Wave(s) | Issue(s)       |
| ---------------------------------------- | ------- | -------------- |
| `package.json`                           | 02      | WP-004         |
| `next.config.ts`                         | 02      | WP-004         |
| `tsconfig.json`                          | 02      | WP-004         |
| `tailwind.config.ts`                     | 02      | WP-004         |
| `app/layout.tsx`                         | 02      | WP-004         |
| `app/globals.css`                        | 02      | WP-004         |
| `app/page.tsx`                           | 02, 03  | WP-004, WP-008 |
| `components/ui/*`                        | 02      | WP-004         |
| `supabase/migrations/*`                  | 02      | WP-005         |
| `lib/supabase/client.ts`                 | 02      | WP-005         |
| `lib/supabase/server.ts`                 | 02      | WP-005         |
| `.env.local.example`                     | 02      | WP-005         |
| `AGENTS.md`                              | 02      | WP-006         |
| `.codex/*`                               | 02      | WP-006         |
| `app/api/auth/callback/route.ts`         | 03      | WP-007         |
| `middleware.ts`                          | 03      | WP-007         |
| `lib/supabase/middleware.ts`             | 03      | WP-007         |
| `app/dashboard/layout.tsx`               | 03      | WP-009         |
| `app/dashboard/page.tsx`                 | 03, 08  | WP-009, WP-026 |
| `components/layout/*`                    | 03      | WP-009         |
| `lib/github/client.ts`                   | 04      | WP-010         |
| `lib/github/types.ts`                    | 04      | WP-010         |
| `app/api/github/repos/route.ts`          | 04      | WP-011         |
| `app/api/github/import/route.ts`         | 04, 06  | WP-011, WP-019 |
| `components/onboarding/*`                | 04      | WP-012         |
| `lib/codex/client.ts`                    | 06      | WP-016         |
| `lib/codex/encoder.ts`                   | 06      | WP-017         |
| `lib/codex/types.ts`                     | 06      | WP-017         |
| `lib/codex/search.ts`                    | 06      | WP-018         |
| `components/brain/BrainScene.tsx`        | 07      | WP-020         |
| `components/brain/ParticleField.tsx`     | 07      | WP-020         |
| `components/brain/EpisodeNode.tsx`       | 07      | WP-021         |
| `components/brain/RuleNode.tsx`          | 07      | WP-021         |
| `components/brain/NeuralEdge.tsx`        | 07      | WP-022         |
| `components/brain/BrainGraph.tsx`        | 07      | WP-022         |
| `components/brain/NodeInteraction.tsx`   | 07      | WP-023         |
| `components/feed/ActivityCard.tsx`       | 08      | WP-024         |
| `components/feed/CodeSnippet.tsx`        | 08      | WP-024         |
| `components/feed/SalienceBadge.tsx`      | 08      | WP-024         |
| `components/feed/TriggerPill.tsx`        | 08      | WP-024         |
| `components/feed/NeuralActivityFeed.tsx` | 08      | WP-025         |
| `lib/codex/consolidator.ts`              | 09      | WP-027         |
| `app/api/consolidate/route.ts`           | 09      | WP-028         |
| `components/brain/SleepTransition.tsx`   | 09      | WP-029         |
| `components/sleep-cycle/*`               | 09, 10  | WP-029, WP-031 |
| `app/sleep-cycle/page.tsx`               | 09      | WP-029         |
| `components/episodes/*`                  | 10      | WP-030         |
| `app/episodes/page.tsx`                  | 10      | WP-030         |
| `tests/*`                                | 10      | WP-032         |
| `vitest.config.ts`                       | 10      | WP-032         |

## Parallelism Notes

- **Wave 01:** WP-001 + WP-002 + WP-003 all parallel (read-only research)
- **Wave 02:** WP-004 + WP-005 + WP-006 all parallel (different files)
- **Wave 03:** WP-007 first, then WP-008 + WP-009 parallel
- **Wave 04:** WP-010 + WP-012 parallel; WP-011 after WP-010
- **Wave 05 (demo repo):** runs in parallel with Waves 04-07 (separate repo)
  - WP-013 first, then WP-014 + WP-015 parallel
- **Wave 06:** WP-016 first; WP-017 + WP-018 parallel; WP-019 after WP-017
- **Wave 07:** Sequential chain: WP-020 → WP-021 → WP-022 → WP-023
- **Wave 08:** WP-024 can start parallel with Wave 07; WP-025 after WP-024; WP-026 after WP-025 + Wave 07
- **Wave 09:** Sequential: WP-027 → WP-028 → WP-029
- **Wave 10:** WP-030 + WP-031 + WP-032 all parallel
- **Wave 11:** Sequential: WP-033 → WP-034

## Assumptions

- Codex SDK supports structured JSON output via `outputSchema` (verified in spike)
- ast-grep has a Node.js binding that can process code strings (verified in spike)
- react-three-fiber v9+ works with postprocessing bloom (verified in spike)
- Supabase free tier sufficient for demo
- GitHub OAuth `repo` scope grants access to read public repo PRs
- shopflow-platform can be created as a public repo with realistic PR history
- gpt-5-mini and gpt-5-nano are available via the Codex SDK
- SSE works from Next.js API routes (standard ReadableStream pattern)

---

## 2026-02-07 Renumbering + Execution Update

This update is the active execution overlay and supersedes the original wave numbering order.

### Wave renumbering
- `Wave 00` (new): Git and GitHub preflight bootstrap.
- `Wave 01`: Existing spike wave remains unchanged.
- `Wave 02` (new): GitHub repo initialization and environment configuration.
- Existing original `Wave 02..11` are shifted to new `Wave 03..12` with unchanged WP scope and acceptance criteria.

### New Wave 02 (inserted)

**Wave 02 — Foundation: GitHub Repo Init + Env Setup**

- Scope: repository initialization tasks only.
- Create `.env.example` with placeholders for:
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`
  - `SUPABASE_SECRET_KEY`
  - `OPENAI_API_KEY`
  - `DEMO_REPO`
- Create local `.env.local` (gitignored) with active values; default `DEMO_REPO=mmeigooni/shopflow-platform`.
- Add a security note and explicit key-rotation follow-up for `OPENAI_API_KEY`.

### Fixed execution protocol
1. Branch naming: `codex/wXX-<wave-slug>`.
2. Worktree pattern: per-WP branch from wave branch.
3. Commit format: `wave-XX(wp-YYY): <imperative summary>`.
4. PR format: `[Wave XX] <title>` with `Context`, `Docs Checked`, `Changes`, `Validation`, `Risks`.
5. Merge mode: merge commit only.
6. End of each wave: push, PR, validate, merge, tag `wave-XX-complete`.
7. Cross-wave: run learnings lookup before wave work and capture learnings after merge.
