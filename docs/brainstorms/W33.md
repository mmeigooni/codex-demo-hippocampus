# Hippocampus — Wave 33 Build Plan

## Objective

Establish visual cohesion across the graph and UI: color nodes by pattern category (not random ID hash), use distinct shapes for node types, modulate episode intensity by salience, and unify the navbar's top-right elements into a cohesive group.

## Scope

| In scope                                            | Out of scope                        |
| --------------------------------------------------- | ----------------------------------- |
| Graph node color assignment by `pattern_key`        | Graph layout algorithm changes      |
| Graph node shape differentiation (octahedron rules) | New node types or edge types        |
| Episode salience → color intensity modulation       | Salience score calculation changes  |
| Feed card color consistency with graph              | Feed card layout or content changes |
| Navbar top-right element unification                | Sidebar or logo changes             |

## Decision Log

| Decision               | Choice                                                                        | Rationale                                                                           | Affects                |
| ---------------------- | ----------------------------------------------------------------------------- | ----------------------------------------------------------------------------------- | ---------------------- |
| Color mapping strategy | 1:1 PatternKey → ColorFamily (10 keys, 10 families)                           | Perfect natural fit, zero ambiguity                                                 | WP-110, WP-112, WP-113 |
| Rule node shape        | Octahedron (8 faces, diamond/gem)                                             | Immediately distinct from episode spheres, reads as "crystallized knowledge"        | WP-112                 |
| Feed card color source | Extract `pattern_key` from `event.raw` at card level                          | Avoids touching event builder chain; `raw` already carries full episode/rule object | WP-113                 |
| Navbar unification     | Merge avatar + username into single chip; convert logout to ghost icon-button | Reduces 3 disparate elements to 2 cohesive ones with shared visual language         | WP-114                 |

## Pattern Key → Color Family Mapping

Curated for semantic fit:

| Pattern Key                 | Color Family | Index | Rationale              |
| --------------------------- | ------------ | ----- | ---------------------- |
| `sensitive-logging`         | Rose         | 2     | Red = danger/alert     |
| `auth-token-handling`       | Orange       | 8     | Warm warning           |
| `concurrency-serialization` | Purple       | 3     | Complexity/depth       |
| `idempotency`               | Fuchsia      | 6     | Uniqueness/distinction |
| `retry-strategy`            | Amber        | 1     | Caution/patience       |
| `state-transition`          | Sky Blue     | 5     | Flow/movement          |
| `input-validation`          | Green        | 4     | Safety/go              |
| `dependency-resilience`     | Teal         | 9     | Stability/resilience   |
| `error-contract`            | Cyan         | 0     | Structure/clarity      |
| `review-hygiene`            | Lime         | 7     | Minor/clean/fresh      |

---

## Wave 33 — Visual Cohesion: Pattern Coloring, Distinct Shapes, Unified Navbar

> Color the graph and feed by pattern category, distinguish rules with octahedron shape, and unify the navbar top-right into a cohesive element group.

### Required Skills (Wave 33)

- `vercel-react-best-practices` — React component patterns and TypeScript
- `threejs-animation` — Three.js geometry and material changes
- `creative-director` — visual design decisions for navbar unification

---

### WP-110: Pattern-key color mapping foundation

- **Priority:** P0
- **Dependencies:** none
- **Files:** `lib/color/cluster-palette.ts`, `components/brain/types.ts`, `tests/cluster-palette.test.ts`
- **Required Skills:**
  - `vercel-react-best-practices` (TypeScript patterns)
- **Objective:** Color lookup functions resolve by `PatternKey` instead of ID hash, and the graph data model carries `patternKey`.
- **Implementation notes:**
  - In `lib/color/cluster-palette.ts`:
    - Import `PatternKey` from `@/lib/memory/pattern-taxonomy` (already exported at line 14)
    - Add `PATTERN_COLOR_INDEX: Record<PatternKey, number>` using the mapping table above
    - Add `getColorFamilyForPatternKey(patternKey: PatternKey): ColorFamily` that does `getColorFamilyByIndex(PATTERN_COLOR_INDEX[patternKey])`
    - Keep existing `getColorFamilyForEpisode`/`getColorFamilyForRule` hash functions as-is (backward compat during rollout) — consumers will migrate to `getColorFamilyForPatternKey` in their own issues
  - In `components/brain/types.ts`:
    - Add `patternKey: string` to `BrainNodeModel` (line ~7, after `triggers`)
  - In `tests/cluster-palette.test.ts`:
    - Add test: each pattern key maps to a unique color family (no collisions)
    - Add test: `getColorFamilyForPatternKey` returns deterministic results
    - Keep existing hash-based tests (functions still exist)
- **Acceptance criteria:**
  - [ ] `getColorFamilyForPatternKey("sensitive-logging")` returns `CLUSTER_PALETTE[2]` (Rose)
  - [ ] All 10 pattern keys map to distinct palette indices (no collisions)
  - [ ] `BrainNodeModel` type includes `patternKey: string`
  - [ ] `npx tsc --noEmit` passes
  - [ ] `npx vitest run tests/cluster-palette.test.ts` passes
- **Evidence:** Test output showing all assertions pass

---

### WP-111: Graph API serves patternKey

- **Priority:** P0
- **Dependencies:** WP-110
- **Files:** `app/api/graph/route.ts`
- **Required Skills:**
  - `next-best-practices` (API route patterns)
- **Objective:** The graph API response includes `patternKey` on every node, sourced from `pattern_key` (episodes) and `rule_key` (rules).
- **Implementation notes:**
  - Add `pattern_key` to episode select at line 209: `"id,title,salience_score,triggers,pattern_key"`
  - Add `rule_key` to rule select at line 216: `"id,title,confidence,triggers,source_episode_ids,rule_key"`
  - Update `EpisodeGraphRecord` (line 16) to include `pattern_key: string`
  - Update `RuleGraphRecord` (line 22) to include `rule_key: string`
  - In `buildGraph` (line 44): set `patternKey: episode.pattern_key` on episode nodes, `patternKey: rule.rule_key` on rule nodes
  - Fallback: `patternKey: "review-hygiene"` if field is missing (safe default, lowest severity)
  - Memory-fallback path (line 159): also extract `pattern_key` from in-memory episodes and `rule_key` from in-memory rules
- **Acceptance criteria:**
  - [ ] Graph API response nodes all contain `patternKey` field
  - [ ] Episode nodes have their `pattern_key` from DB; rule nodes have their `rule_key`
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** `curl` the graph API endpoint and verify `patternKey` appears on nodes

---

### WP-112: Graph nodes use pattern color + octahedron rules

- **Priority:** P1
- **Dependencies:** WP-110, WP-111
- **Files:** `components/brain/EpisodeNode.tsx`, `components/brain/RuleNode.tsx`, `components/brain/BrainGraph.tsx`
- **Required Skills:**
  - `threejs-animation` (Three.js geometry)
  - `vercel-react-best-practices` (React component props)
- **Objective:** Graph nodes color by pattern key (same pattern = same color), rules render as octahedrons, episode glow intensity scales with salience.
- **Implementation notes:**
  - `EpisodeNode.tsx`:
    - Add `patternKey: string` prop
    - Replace `getColorFamilyForEpisode(nodeId)` (line 24) with `getColorFamilyForPatternKey(patternKey as PatternKey)`
    - Enhance salience-based glow: scale outer mesh opacity from `0.03` (salience 0) to `0.12` (salience 10) instead of fixed `0.06`/`0.08`
  - `RuleNode.tsx`:
    - Add `patternKey: string` prop
    - Replace `getColorFamilyForRule(nodeId)` (line 21) with `getColorFamilyForPatternKey(patternKey as PatternKey)`
    - Switch `<icosahedronGeometry args={[0.42, 1]} />` to `<octahedronGeometry args={[0.42, 0]} />` (both line 56 and line 69 for glow mesh)
  - `BrainGraph.tsx`:
    - Pass `patternKey={node.patternKey}` to `EpisodeNode` (line 201) and `RuleNode` (line 190)
    - Edge coloring (line 156-159): replace hash-based lookup with `getColorFamilyForPatternKey(sourceNode.patternKey as PatternKey).border`
    - Remove imports of `getColorFamilyForEpisode`/`getColorFamilyForRule` (line 13), import `getColorFamilyForPatternKey` instead
- **Acceptance criteria:**
  - [ ] Two episodes with same `pattern_key` render the same color
  - [ ] A rule and its child episodes share the same color
  - [ ] Rule nodes render as octahedrons (diamond shape), episodes as spheres
  - [ ] High-salience episodes glow more visibly than low-salience ones
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Visual verification in browser — screenshot of graph showing color clustering

---

### WP-113: Feed cards use pattern-based color

- **Priority:** P1
- **Dependencies:** WP-110
- **Files:** `components/feed/ActivityCard.tsx`, `components/feed/PRGroupCard.tsx`, `components/feed/RuleGroupCard.tsx`
- **Required Skills:**
  - `vercel-react-best-practices` (React patterns)
- **Objective:** Feed cards color-match the graph by resolving color from `pattern_key` in raw event data.
- **Implementation notes:**
  - Strategy: extract `pattern_key` (episodes) or `rule_key` (rules) from `event.raw` at the card component level. The raw data already contains the full episode/rule object, so no upstream event-builder changes needed.
  - `ActivityCard.tsx`:
    - Update `resolveClusterColor` (line 66): check `event.raw.episode?.pattern_key` or `event.raw.pattern_key`, if present use `getColorFamilyForPatternKey()`, else fall back to existing hash behavior
    - Import `getColorFamilyForPatternKey` from cluster-palette
  - `PRGroupCard.tsx`:
    - Update `resolveClusterColor` (line 41): same pattern — try `pattern_key` from first episode's raw data
    - Import `getColorFamilyForPatternKey`
  - `RuleGroupCard.tsx`:
    - Line 56: try extracting `rule_key` from the card's raw context (available via `ruleId` prefix or could be passed as prop), use `getColorFamilyForPatternKey()` when available
    - Import `getColorFamilyForPatternKey`
  - All three files: keep hash-based fallback for events that lack `pattern_key` in raw data (non-import events like consolidation reasoning)
- **Acceptance criteria:**
  - [ ] A feed card and its corresponding graph node share the same color
  - [ ] Cards without `pattern_key` in raw data still render with fallback color
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Visual comparison — click a graph node, the highlighted feed card matches its color

---

### WP-114: Unify navbar top-right elements

- **Priority:** P1
- **Dependencies:** none
- **Files:** `components/layout/Header.tsx`, `components/layout/LogoutButton.tsx`
- **Required Skills:**
  - `vercel-react-best-practices` (React component patterns)
  - `creative-director` (visual design cohesion)
- **Objective:** The three top-right navbar elements (username badge, avatar, logout button) become a cohesive visual group instead of three disparate components.
- **Implementation notes:**
  - Current state (3 unrelated elements):
    1. Username Badge — `bg-cyan-500/20 text-cyan-100`, rounded-full
    2. Avatar — `border-zinc-700`, rounded-full
    3. Logout Button — `variant="outline" size="sm"`, rounded-md, shadow-xs
  - Target: merge avatar + username into a single "user chip", convert logout to a subtle icon-button
  - `Header.tsx`:
    - Combine avatar + username into a single pill-shaped container: `flex items-center gap-2 rounded-full border border-zinc-700/60 bg-zinc-900/50 px-3 py-1.5`
    - Avatar goes inside the pill (left), username text (right, `text-sm text-zinc-300`)
    - Remove the standalone `Badge` import and usage
    - Keep the `LogoutButton` as a separate element but visually toned to match
  - `LogoutButton.tsx`:
    - Switch from text "Logout" to `LogOut` icon from lucide-react (consistent with icon library already in use)
    - Use `variant="ghost" size="icon-sm"` instead of `variant="outline" size="sm"`
    - Styling: `text-zinc-400 hover:text-zinc-100 hover:bg-zinc-800` — muted by default, visible on hover
    - Keep loading state: show a spinner or disabled state during sign-out
  - Result: two elements that share the same muted zinc palette — a user chip (avatar + name) and a subtle icon button
- **Acceptance criteria:**
  - [ ] Top-right shows avatar + username as a single grouped element
  - [ ] Logout renders as a ghost icon button matching the zinc color language
  - [ ] Hover states feel cohesive across both elements
  - [ ] Loading state still works during sign-out
  - [ ] `npx tsc --noEmit` passes
- **Evidence:** Screenshot of navbar showing unified top-right group

---

**Wave exit:** `npx tsc --noEmit && npx vitest run` both pass. Visual verification: graph nodes cluster by color, rules are diamond-shaped, navbar top-right is cohesive.

**Wave completion:** All issue PRs merged → exit gate passed → wave commit + tag → full sync checkpoint.

---

## File Ownership Matrix

| File                                 | Wave | Issue(s) |
| ------------------------------------ | ---- | -------- |
| `lib/color/cluster-palette.ts`       | 33   | WP-110   |
| `components/brain/types.ts`          | 33   | WP-110   |
| `tests/cluster-palette.test.ts`      | 33   | WP-110   |
| `app/api/graph/route.ts`             | 33   | WP-111   |
| `components/brain/EpisodeNode.tsx`   | 33   | WP-112   |
| `components/brain/RuleNode.tsx`      | 33   | WP-112   |
| `components/brain/BrainGraph.tsx`    | 33   | WP-112   |
| `components/feed/ActivityCard.tsx`   | 33   | WP-113   |
| `components/feed/PRGroupCard.tsx`    | 33   | WP-113   |
| `components/feed/RuleGroupCard.tsx`  | 33   | WP-113   |
| `components/layout/Header.tsx`       | 33   | WP-114   |
| `components/layout/LogoutButton.tsx` | 33   | WP-114   |

Zero within-wave file overlap.

## Parallelism Notes

```
WP-110 (foundation) — sequential, first
    ↓
    ├─ WP-111 (graph API) — sequential after WP-110
    │      ↓
    │      └─ WP-112 (graph nodes) — after WP-111
    │
    ├─ WP-113 (feed cards) — parallel with WP-111 (only needs WP-110)
    │
    └─ WP-114 (navbar) — parallel with everything (no deps)
```

- WP-114 can start immediately (independent files, no color system dependency)
- WP-113 can start as soon as WP-110 merges
- WP-112 waits for both WP-110 and WP-111

## Assumptions

- `pattern_key` column exists on all episode rows (per migration 002)
- `rule_key` column exists on all rule rows (per migration 002)
- Memory-fallback store episode/rule objects also carry `pattern_key`/`rule_key`
- `lucide-react` `LogOut` icon is available (lucide-react 0.563.0 already installed)
